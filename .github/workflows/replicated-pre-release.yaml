name: Helm Chart Release
on:
  release:
    types: [prereleased, released]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-helm-chart:
    runs-on: ubuntu-latest
    if: |
      github.event.action == 'prereleased' 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.tag_name }}
      
      - name: Extract version and set promotion channel
        id: metadata
        run: |
          TAG_NAME=${{ github.event.release.tag_name }}
          
          echo "::group::Debug Info"
          echo "Tag: $TAG_NAME"
          echo "Release Name: ${{ github.event.release.name }}"
          echo "Is Prerelease: ${{ github.event.release.prerelease }}"
          echo "::endgroup::"
          
          # Determine promotion channel based on tag pattern
          if [[ "$TAG_NAME" == release-beta-* ]]; then
            PROMOTE="Beta"
          else
            PROMOTE="Unstable"
          fi
          
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "promote=$PROMOTE" >> $GITHUB_OUTPUT
          echo "âœ… Tag: $TAG_NAME"
          echo "âœ… Promote: $PROMOTE"
      
      - name: Install yq
        uses: mikefarah/yq@v4
      
      - name: Install Replicated CLI
        run: |
          version=$(curl -s https://api.github.com/repos/replicatedhq/replicated/releases/latest \
            | grep -m1 -Po '"tag_name":\s*"v\K[^"]+')
          curl -Ls \
            "https://github.com/replicatedhq/replicated/releases/download/v${version}/replicated_${version}_linux_amd64.tar.gz" \
            -o replicated.tar.gz
          tar xf replicated.tar.gz replicated && rm replicated.tar.gz
          sudo mv replicated /usr/local/bin/replicated
      
      - name: Check replicated
        run: |
          set -e
          replicated app ls &> /dev/null || exit 1 
        env:
          REPLICATED_API_TOKEN: ${{ secrets.REPLICATED_API_TOKEN }}
      
      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'
      
      - name: Run Helm template  
        run: | 
          helm template composio ./composio
      
      - name: Get and bump version
        id: version
        env:
          REPLICATED_APP: ${{ secrets.REPLICATED_APP }}
          REPLICATED_API_TOKEN: ${{ secrets.REPLICATED_API_TOKEN }}
        run: |
          cd ./composio
          CURRENT_APPVERSION=$(replicated channel ls | grep "Unstable" | awk '{print $NF}')
          NEW_APPVERSION=$(echo "$CURRENT_APPVERSION" | awk -F. '{$NF = $NF + 1} 1' OFS=.)
          echo "current=$CURRENT_APPVERSION" >> $GITHUB_OUTPUT
          echo "new=$NEW_APPVERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_APPVERSION"
          echo "New version: $NEW_APPVERSION"

      - name: Update Chart.yaml versions
        run: |
          cd ./composio
          export NEW_VERSION="${{ steps.version.outputs.new }}"
          yq eval -i '.appVersion = strenv(NEW_VERSION)' ./Chart.yaml
          yq eval -i '.version = strenv(NEW_VERSION)' ./Chart.yaml
          echo "Updated Chart.yaml"

      - name: Update manifest versions
        run: |
          cd ./manifests
          export NEW_VERSION="${{ steps.version.outputs.new }}"
          yq eval -i '.metadata.labels."app.kubernetes.io/version" = strenv(NEW_VERSION)' ./k8s-app.yaml
          yq eval -i '.spec.descriptor.version = strenv(NEW_VERSION)' ./k8s-app.yaml
          yq eval -i '.spec.chart.chartVersion = strenv(NEW_VERSION)' ./composio.yaml
          echo "Updated manifest files"

      - name: Clean old packages
        run: |
          echo "Removing old tgz files"
          rm -f ./manifests/*.tgz

      - name: Package and create Replicated release
        run: |
          echo "Packaging Helm chart..."
          helm package ./composio --destination manifests
          echo "Creating Replicated release..."
          replicated release create \
          --yaml-dir manifests \
          --promote "${{ steps.metadata.outputs.promote }}" \
          --version "${{ steps.version.outputs.new }}"
        env:
          REPLICATED_API_TOKEN: ${{ secrets.REPLICATED_API_TOKEN }}
          REPLICATED_APP: composio-rodent
  deploy-to-gke:
    needs: [release-helm-chart]
    if: |
      github.event.action == 'prereleased'
    env:
      REPLICATED_APP: ${{ secrets.REPLICATED_APP }} 
    runs-on: depot-ubuntu-24.04-4
    permissions:
      contents: write
    steps:
      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Set up Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GKE_SA_KEY }}
          project_id: ${{ secrets.GKE_PROJECT_ID }}

      - name: Install GKE Auth Plugin
        run: |
          echo "ðŸ”§ Installing gke-gcloud-auth-plugin..."
          gcloud components install gke-gcloud-auth-plugin --quiet &> /dev/null || exit 1 
          echo "âœ… GKE auth plugin installed successfully"

      - name: Configure kubectl for GKE
        env: 
          GKE_CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
          GKE_CLUSTER_ZONE: ${{ secrets.GKE_CLUSTER_ZONE }}
        run: |
          gcloud container clusters get-credentials "$GKE_CLUSTER_NAME" --zone "$GKE_CLUSTER_ZONE" &> /dev/null || exit 1  
          echo "âœ… Kubectl configured successfully"

      - name: Verify GKE Connection
        run: |
          echo "ðŸ” Verifying GKE cluster connection..."
          kubectl get namespaces &> /dev/null || exit 1 
          echo "âœ… GKE connection verified"

      - name: Generate Values Override
        env:
          VALUES_OVERRIDE: ${{ secrets.HELM_VALUES_OVERRIDE }}
        run: |
          echo "ðŸ”§ Generating deployment values override..."
          cat > values-override.yaml << EOF
          $VALUES_OVERRIDE
          EOF

      - name: Install Replicated CLI
        run: |
          version=$(curl -s https://api.github.com/repos/replicatedhq/replicated/releases/latest \
            | grep -m1 -Po '"tag_name":\s*"v\K[^"]+')
          curl -Ls \
            "https://github.com/replicatedhq/replicated/releases/download/v${version}/replicated_${version}_linux_amd64.tar.gz" \
            -o replicated.tar.gz
          tar xf replicated.tar.gz replicated && rm replicated.tar.gz
          mv replicated /usr/local/bin/replicated

      - name:  Check replicated
        env:
          REPLICATED_API_TOKEN: ${{ secrets.REPLICATED_API_TOKEN }} 
        run: |
          set -e
          replicated app ls &> /dev/null || exit 1
      
      - name: Get latest replicated version
        id: get_version
        env:
          REPLICATED_APP: ${{ secrets.REPLICATED_APP }}
          REPLICATED_API_TOKEN: ${{ secrets.REPLICATED_API_TOKEN }} 
        run: |
          STABLE_VERSION=$(replicated channel ls | grep "Stable" | awk '{print $NF}')
          UNSTABLE_VERSION=$(replicated channel ls | grep "Unstable" | awk '{print $NF}')
          echo "Stable version: $STABLE_VERSION"
          echo "Unstable version: $UNSTABLE_VERSION"
          echo "stable=$STABLE_VERSION" >> $GITHUB_OUTPUT
          echo "unstable=$UNSTABLE_VERSION" >> $GITHUB_OUTPUT

      
      - name: Deploy on kubernetes using replicated 
        env:
          AUTH_TOKEN: ${{ secrets.REPLICATED_HELM_AUTH_TOKEN }}
          REPLICATED_USERNAME: ${{ secrets.REPLICATED_USERNAME }} 
          HELM_URL: ${{ secrets.HELM_REGISTRY }}
          REPLICATED_REGISTRY: ${{ secrets.REPLICATED_REGISTRY }}
        run: |

          helm registry login $REPLICATED_REGISTRY --username $REPLICATED_USERNAME --password $AUTH_TOKEN 
          helm upgrade composio $HELM_URL  \
            --install \
            --create-namespace \
            --namespace composio \
            --values ./values-override.yaml \
            --wait \
            --timeout 20m \
            --version ${{ steps.get_version.outputs.unstable }} 

      - name: Deployment Summary
        if: success()
        run: |
          echo "ðŸŽ‰ Deployment completed successfully!"

      - name: Handle Deployment Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"

  release-stable:
    runs-on: ubuntu-latest
    if: github.event.action == 'released'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.tag_name }}
      
      - name: Extract version
        id: metadata
        run: |
          TAG_NAME=${{ github.event.release.tag_name }}
          
          echo "::group::Release Info"
          echo "Tag: $TAG_NAME"
          echo "Release Name: ${{ github.event.release.name }}"
          echo "Converting pre-release to stable release"
          echo "::endgroup::"
          
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "promote=Stable" >> $GITHUB_OUTPUT
          echo "âœ… Tag: $TAG_NAME"
          echo "âœ… Promote: Stable"
      
      - name: Install yq
        uses: mikefarah/yq@v4
      
      - name: Install Replicated CLI
        run: |
          version=$(curl -s https://api.github.com/repos/replicatedhq/replicated/releases/latest \
            | grep -m1 -Po '"tag_name":\s*"v\K[^"]+')
          curl -Ls \
            "https://github.com/replicatedhq/replicated/releases/download/v${version}/replicated_${version}_linux_amd64.tar.gz" \
            -o replicated.tar.gz
          tar xf replicated.tar.gz replicated && rm replicated.tar.gz
          sudo mv replicated /usr/local/bin/replicated
      
      - name: Check replicated
        run: |
          set -e
          replicated app ls &> /dev/null || exit 1 
        env:
          REPLICATED_API_TOKEN: ${{ secrets.REPLICATED_API_TOKEN }}
      
      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'
      
      - name: Get and bump version
        id: version
        env:
          REPLICATED_APP: ${{ secrets.REPLICATED_APP }}
          REPLICATED_API_TOKEN: ${{ secrets.REPLICATED_API_TOKEN }}
        run: |
          cd ./composio
          CURRENT_APPVERSION=$(replicated channel ls | grep "Stable" | awk '{print $NF}')
          NEW_APPVERSION=$(echo "$CURRENT_APPVERSION" | awk -F. '{$NF = $NF + 1} 1' OFS=.)
          echo "current=$CURRENT_APPVERSION" >> $GITHUB_OUTPUT
          echo "new=$NEW_APPVERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_APPVERSION"
          echo "New version: $NEW_APPVERSION"

      - name: Update Chart.yaml versions
        run: |
          cd ./composio
          export NEW_VERSION="${{ steps.version.outputs.new }}"
          yq eval -i '.appVersion = strenv(NEW_VERSION)' ./Chart.yaml
          yq eval -i '.version = strenv(NEW_VERSION)' ./Chart.yaml
          echo "Updated Chart.yaml"

      - name: Update manifest versions
        run: |
          cd ./manifests
          export NEW_VERSION="${{ steps.version.outputs.new }}"
          yq eval -i '.metadata.labels."app.kubernetes.io/version" = strenv(NEW_VERSION)' ./k8s-app.yaml
          yq eval -i '.spec.descriptor.version = strenv(NEW_VERSION)' ./k8s-app.yaml
          yq eval -i '.spec.chart.chartVersion = strenv(NEW_VERSION)' ./composio.yaml
          echo "Updated manifest files"

      - name: Clean old packages
        run: |
          echo "Removing old tgz files"
          rm -f ./manifests/*.tgz

      - name: Package and promote to Stable
        run: |
          echo "Packaging Helm chart..."
          helm package ./composio --destination manifests
          echo "Promoting existing version to Stable channel..."
          replicated release create \
            --yaml-dir manifests \
            --promote Stable \
            --version "${{ steps.version.outputs.new }}"
        env:
          REPLICATED_API_TOKEN: ${{ secrets.REPLICATED_API_TOKEN }}
          REPLICATED_APP: composio-rodent

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.TOKEN_GITHUB_HELM }}
          commit-message: "chore: bump helm chart version to ${{ steps.version.outputs.new }}"
          branch: release-${{ steps.version.outputs.new }}-${{ github.run_number }}
          base: release-stable
          title: "Release: Helm Chart v${{ steps.version.outputs.new }}"
          body: |
            ## Helm Chart Release
            
            This PR contains version updates for the Helm chart release.
            
            ### Changes
            - **Previous Version:** ${{ steps.version.outputs.current }}
            - **New Version:** ${{ steps.version.outputs.new }}
            - **Release Tag:** ${{ steps.metadata.outputs.tag }}
            - **Channel:** Stable
            
            ### Updated Files
            - `composio/Chart.yaml` - Updated appVersion and version
            - `manifests/k8s-app.yaml` - Updated app version
            - `manifests/composio.yaml` - Updated chart version
            - `manifests/*.tgz` - New Helm package
            
            ### Replicated Release
            Created Replicated release with version ${{ steps.version.outputs.current }} and promoted to Stable channel.
            
            ---
            *Automated PR created by Helm Chart Release workflow*
          labels: |
            release
            automated
          assignees: ${{ github.actor }}

      - name: PR Summary
        run: |
          echo "### Helm Chart Release PR Created ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.new }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** release-${{ steps.version.outputs.new }}-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target:** release-stable" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ steps.metadata.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
