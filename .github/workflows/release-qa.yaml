name: "Deploy to QA"

on:
  release:
    types: [prereleased]
  workflow_dispatch:
    inputs:
      helm_chart_version:
        description: 'Replicated version to deploy'
        required: false
        type: string

jobs: 
  deploy-to-gke:
    env:
      REPLICATED_APP: ${{ secrets.REPLICATED_APP }} 
    runs-on: depot-ubuntu-24.04-4
    permissions:
      contents: write
    steps:
      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Set up Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GKE_SA_KEY }}
          project_id: ${{ secrets.GKE_PROJECT_ID }}

      - name: Install GKE Auth Plugin
        run: |
          echo "üîß Installing gke-gcloud-auth-plugin..."
          gcloud components install gke-gcloud-auth-plugin --quiet &> /dev/null || exit 1 
          echo "‚úÖ GKE auth plugin installed successfully"

      - name: Configure kubectl for GKE
        env: 
          GKE_CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
          GKE_CLUSTER_ZONE: ${{ secrets.GKE_CLUSTER_ZONE }}
        run: |
          gcloud container clusters get-credentials "$GKE_CLUSTER_NAME" --zone "$GKE_CLUSTER_ZONE" &> /dev/null || exit 1  
          echo "‚úÖ Kubectl configured successfully"

      - name: Verify GKE Connection
        run: |
          echo "üîç Verifying GKE cluster connection..."
          kubectl get namespaces &> /dev/null || exit 1 
          echo "‚úÖ GKE connection verified"

      - name: Generate Values Override
        env:
          VALUES_OVERRIDE: ${{ secrets.HELM_VALUES_OVERRIDE }}
        run: |
          echo "üîß Generating deployment values override..."
          cat > values-override.yaml << EOF
           $VALUES_OVERRIDE
          EOF

      - name: Install Replicated CLI
        run: |
          version=$(curl -s https://api.github.com/repos/replicatedhq/replicated/releases/latest \
            | grep -m1 -Po '"tag_name":\s*"v\K[^"]+')
          curl -Ls \
            "https://github.com/replicatedhq/replicated/releases/download/v${version}/replicated_${version}_linux_amd64.tar.gz" \
            -o replicated.tar.gz
          tar xf replicated.tar.gz replicated && rm replicated.tar.gz
          mv replicated /usr/local/bin/replicated

      - name:  Check replicated
        env:
          REPLICATED_API_TOKEN: ${{ secrets.REPLICATED_API_TOKEN }} 
        run: |
          set -e
          replicated app ls &> /dev/null || exit 1
      
      - name: Get latest replicated version
        id: get_version
        env:
          REPLICATED_APP: ${{ secrets.REPLICATED_APP }}
        run: |
          STABLE_VERSION=$(replicated channel ls | grep "Stable" | awk '{print $NF}')
          UNSTABLE_VERSION=$(replicated channel ls | grep "Unstable" | awk '{print $NF}')
          echo "Stable version: $STABLE_VERSION"
          echo "Unstable version: $UNSTABLE_VERSION"
          echo "stable=$STABLE_VERSION" >> $GITHUB_OUTPUT
          echo "unstable=$UNSTABLE_VERSION" >> $GITHUB_OUTPUT

      
      - name: Deploy on kubernetes using replicated 
        env:
          AUTH_TOKEN: ${{ secrets.REPLICATED_HELM_AUTH_TOKEN }}
          REPLICATED_USERNAME: ${{ secrets.REPLICATED_USERNAME }} 
          HELM_URL: ${{ secrets.HELM_REGISTRY }}
          REPLICATED_REGISTRY: ${{ secrets.REPLICATED_REGISTRY }}
        run: | 
          
          helm registry login $REPLICATED_REGISTRY --username $REPLICATED_USERNAME --password $AUTH_TOKEN 

          helm upgrade composio $HELM_URL  \
            --install \
            --create-namespace \
            --namespace composio \
            --values values-override.yaml \
            --wait \
            --timeout 20m \
            --version ${{ steps.get_version.outputs.unstable }} 

      - name: Deployment Summary
        if: success()
        run: |
          echo "üéâ Deployment completed successfully!"

      - name: Handle Deployment Failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"

