suite: test apollo configmap
templates:
  - apollo/apollo-configmap.yaml
tests:
  - it: should create apollo configmap
    asserts:
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: RELEASE-NAME-apollo-config
      - equal:
          path: metadata.labels.app
          value: apollo

  - it: should have correct default PORT
    asserts:
      - equal:
          path: data.PORT
          value: "9900"

  - it: should have correct default HOSTNAME
    asserts:
      - equal:
          path: data.HOSTNAME
          value: "0.0.0.0"

  - it: should have correct default NODE_ENV
    asserts:
      - equal:
          path: data.NODE_ENV
          value: "production"

  - it: should have SELF_HOSTED set to true
    asserts:
      - equal:
          path: data.SELF_HOSTED
          value: "true"

  - it: should have correct COMPOSIO_ENV
    asserts:
      - equal:
          path: data.COMPOSIO_ENV
          value: "production"

  - it: should have correct NODE_OPTIONS
    asserts:
      - equal:
          path: data.NODE_OPTIONS
          value: "--max-old-space-size=4096"

  - it: should have correct THERMOS_URL
    asserts:
      - equal:
          path: data.THERMOS_URL
          value: "http://RELEASE-NAME-thermos:8180"

  - it: should have default BACKEND_URL
    asserts:
      - equal:
          path: data.BACKEND_URL
          value: "http://RELEASE-NAME-apollo:9900"

  - it: should use custom BACKEND_URL when overwrite_apollo_url is set
    set:
      apollo.overwrite_apollo_url: "https://api.example.com"
    asserts:
      - equal:
          path: data.BACKEND_URL
          value: "https://api.example.com"
      - equal:
          path: data.OVERWRITE_APOLLO_URL
          value: "https://api.example.com"

  - it: should have default APOLLO_URL
    asserts:
      - equal:
          path: data.APOLLO_URL
          value: "http://RELEASE-NAME-apollo:9900"

  - it: should configure AWS_REGION
    set:
      aws.region: "us-west-2"
    asserts:
      - equal:
          path: data.AWS_REGION
          value: "us-west-2"

  - it: should configure S3 settings
    set:
      apollo.s3ForcePathStyle: "true"
      apollo.s3Endpoint: "https://s3.example.com"
      apollo.s3EndpointUrl: "https://s3.example.com"
      apollo.s3Region: "us-east-1"
      apollo.s3SignatureVersion: "v4"
      apollo.s3Bucket: "my-bucket"
    asserts:
      - equal:
          path: data.S3_FORCE_PATH_STYLE
          value: "true"
      - equal:
          path: data.S3_ENDPOINT
          value: "https://s3.example.com"
      - equal:
          path: data.S3_ENDPOINT_URL
          value: "https://s3.example.com"
      - equal:
          path: data.S3_REGION
          value: "us-east-1"
      - equal:
          path: data.S3_SIGNATURE_VERSION
          value: "v4"
      - equal:
          path: data.S3_BUCKET
          value: "my-bucket"

  - it: should configure object storage backend
    set:
      apollo.objectStorage.backend: "azure"
    asserts:
      - equal:
          path: data.OBJECT_STORAGE_BACKEND
          value: "azure"

  - it: should configure object storage namespaces
    set:
      apollo.objectStorage.namespaces:
        temp: "temp-storage"
        permanent: "permanent-storage"
    asserts:
      - equal:
          path: data.TEMP_STORAGE_NAMESPACE
          value: "temp-storage"
      - equal:
          path: data.PERMANENT_STORAGE_NAMESPACE
          value: "permanent-storage"

  - it: should configure OTEL when enabled
    set:
      otel.enabled: true
      otel.apollo:
        serviceName: "my-apollo"
        serviceVersion: "2.0.0"
      otel.environment: "staging"
    asserts:
      - equal:
          path: data.OTEL_ENABLED
          value: "true"
      - equal:
          path: data.OTEL_SERVICE_NAME
          value: "my-apollo"
      - equal:
          path: data.OTEL_SERVICE_VERSION
          value: "2.0.0"
      - equal:
          path: data.OTEL_ENVIRONMENT
          value: "staging"
      - equal:
          path: data.OTEL_TRACES_EXPORTER
          value: "otlp"
      - equal:
          path: data.OTEL_METRICS_EXPORTER
          value: "otlp"
      - equal:
          path: data.OTEL_LOGS_EXPORTER
          value: "otlp"

  - it: should configure Weaviate when enabled
    set:
      weaviate.enabled: true
      weaviate.service.port: 8080
      apollo.search.weaviate.collection: "MyCollection"
    asserts:
      - equal:
          path: data.WEAVIATE_URL
          value: "http://RELEASE-NAME-weaviate:8080"
      - equal:
          path: data.WEAVIATE_HOST
          value: "RELEASE-NAME-weaviate"
      - equal:
          path: data.WEAVIATE_PORT
          value: "8080"
      - equal:
          path: data.WEAVIATE_COLLECTION
          value: "MyCollection"

  - it: should configure Google service account when enabled
    set:
      apollo.googleServiceAccount:
        enabled: true
        mountPath: "/var/secrets/google"
    asserts:
      - equal:
          path: data.GOOGLE_APPLICATION_CREDENTIALS
          value: "/var/secrets/google/key.json"

  - it: should configure FRONTEND_URL when overwrite_fe_url is set
    set:
      apollo.overwrite_fe_url: "https://app.example.com"
    asserts:
      - equal:
          path: data.FRONTEND_URL
          value: "https://app.example.com"
      - equal:
          path: data.OVERWRITE_FE_URL
          value: "https://app.example.com"

  - it: should configure search settings when enabled
    set:
      weaviate.enabled: true
      openAI.enabled: true
      apollo.search.enabled: true
      apollo.search.vectorStoreProvider: "weaviate"
      apollo.search.embeddings:
        provider: "openai"
        model: "text-embedding-3-small"
        dimensions: 512
    asserts:
      - equal:
          path: data.VECTOR_STORE_PROVIDER
          value: "weaviate"
      - equal:
          path: data.EMBEDDINGS_PROVIDER
          value: "openai"
      - equal:
          path: data.EMBEDDINGS_MODEL
          value: "text-embedding-3-small"
      - equal:
          path: data.EMBEDDINGS_DIMENSIONS
          value: "512"
