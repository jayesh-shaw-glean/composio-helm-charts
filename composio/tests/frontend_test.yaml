suite: test frontend deployment
templates:
  - frontend/frontend.yaml
tests:
  - it: should not create resources when frontend is disabled
    set:
      frontend.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should create frontend deployment when enabled
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
    documentIndex: 0
    asserts:
      - isKind:
          of: Deployment
      - matchRegex:
          path: metadata.name
          pattern: ".*-frontend$"
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: frontend

  - it: should have correct replica count
    set:
      frontend.enabled: true
      frontend.replicaCount: 3
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
    documentIndex: 0
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should use correct image
    set:
      frontend.enabled: true
      frontend.image.repository: my-registry/frontend
      frontend.image.tag: "v2.0.0"
      frontend.image.pullPolicy: IfNotPresent
    documentIndex: 0
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ".*/my-registry/frontend:v2.0.0$"
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: IfNotPresent

  - it: should have correct port configuration
    set:
      frontend.enabled: true
      frontend.service.port: 3000
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
    documentIndex: 0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 3000

  - it: should have liveness probe
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
    documentIndex: 0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /api/health
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 3000
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 60

  - it: should have readiness probe
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
    documentIndex: 0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /api/health
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 3000
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.initialDelaySeconds
          value: 30

  - it: should have rolling update strategy
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
    documentIndex: 0
    asserts:
      - equal:
          path: spec.strategy.type
          value: RollingUpdate
      - equal:
          path: spec.strategy.rollingUpdate.maxUnavailable
          value: 0
      - equal:
          path: spec.strategy.rollingUpdate.maxSurge
          value: 1

  - it: should include image pull secrets when configured
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
      global.imagePullSecrets:
        - name: frontend-secret
    documentIndex: 0
    asserts:
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: frontend-secret

  - it: should have correct resource limits
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
      frontend.resources:
        requests:
          memory: "1Gi"
          cpu: "500m"
        limits:
          memory: "2Gi"
          cpu: "1"
    documentIndex: 0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: "1Gi"
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: "500m"
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: "2Gi"
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: "1"

  - it: should apply pod security context when configured
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
      frontend.podSecurityContext:
        fsGroup: 1000
        runAsNonRoot: true
    documentIndex: 0
    asserts:
      - equal:
          path: spec.template.spec.securityContext.fsGroup
          value: 1000
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true

  - it: should apply container security context when configured
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
      frontend.containerSecurityContext:
        allowPrivilegeEscalation: false
        runAsNonRoot: true
        runAsUser: 1000
    documentIndex: 0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 1000

  - it: should apply node selector when configured
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
      frontend.nodeSelector:
        kubernetes.io/os: linux
    documentIndex: 0
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector["kubernetes.io/os"]
          value: linux

  - it: should apply tolerations when configured
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
      frontend.tolerations:
        - key: "key1"
          operator: "Equal"
          value: "value1"
          effect: "NoSchedule"
    documentIndex: 0
    asserts:
      - contains:
          path: spec.template.spec.tolerations
          content:
            key: "key1"
            operator: "Equal"
            value: "value1"
            effect: "NoSchedule"

---
suite: test frontend service
templates:
  - frontend/frontend.yaml
tests:
  - it: should create frontend service when enabled
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
    documentIndex: 1
    asserts:
      - isKind:
          of: Service
      - matchRegex:
          path: metadata.name
          pattern: ".*-frontend$"
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: frontend

  - it: should have correct service type and port
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
      frontend.service.type: ClusterIP
      frontend.service.port: 3000
    documentIndex: 1
    asserts:
      - equal:
          path: spec.type
          value: ClusterIP
      - equal:
          path: spec.ports[0].port
          value: 3000
      - equal:
          path: spec.ports[0].targetPort
          value: 3000

  - it: should support NodePort service type
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
      frontend.service.type: NodePort
      frontend.service.port: 3000
      frontend.service.nodePort: 30300
    documentIndex: 1
    asserts:
      - equal:
          path: spec.type
          value: NodePort
      - equal:
          path: spec.ports[0].nodePort
          value: 30300

  - it: should have correct selector labels
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
    documentIndex: 1
    asserts:
      - equal:
          path: spec.selector["app.kubernetes.io/component"]
          value: frontend

---
suite: test frontend horizontal pod autoscaler
templates:
  - frontend/frontend.yaml
tests:
  - it: should not create HPA when autoscaling is disabled
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
      frontend.autoscaling:
        enabled: false
    asserts:
      - hasDocuments:
          count: 2

  - it: should create HPA when autoscaling is enabled
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
      frontend.autoscaling:
        enabled: true
        minReplicas: 2
        maxReplicas: 10
        targetCPUUtilizationPercentage: 80
    documentIndex: 2
    asserts:
      - isKind:
          of: HorizontalPodAutoscaler
      - matchRegex:
          path: metadata.name
          pattern: ".*-frontend$"
      - equal:
          path: spec.minReplicas
          value: 2
      - equal:
          path: spec.maxReplicas
          value: 10

  - it: should configure CPU-based autoscaling
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
      frontend.autoscaling:
        enabled: true
        targetCPUUtilizationPercentage: 75
    documentIndex: 2
    asserts:
      - equal:
          path: spec.metrics[0].resource.name
          value: cpu
      - equal:
          path: spec.metrics[0].resource.target.averageUtilization
          value: 75

  - it: should configure memory-based autoscaling
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
      frontend.autoscaling:
        enabled: true
        targetMemoryUtilizationPercentage: 80
    documentIndex: 2
    asserts:
      - contains:
          path: spec.metrics
          content:
            type: Resource
            resource:
              name: memory
              target:
                type: Utilization
                averageUtilization: 80

  - it: should configure scale down behavior
    set:
      frontend.enabled: true
      frontend.image.repository: test-frontend
      frontend.image.tag: "v1.0.0"
      frontend.autoscaling:
        enabled: true
        targetCPUUtilizationPercentage: 80
        scaleDownStabilizationWindowSeconds: 600
        scaleDownPercent: 20
        scaleDownPeriodSeconds: 120
    documentIndex: 2
    asserts:
      - equal:
          path: spec.behavior.scaleDown.stabilizationWindowSeconds
          value: 600
      - equal:
          path: spec.behavior.scaleDown.policies[0].value
          value: 20
      - equal:
          path: spec.behavior.scaleDown.policies[0].periodSeconds
          value: 120
