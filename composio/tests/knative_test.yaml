suite: test knative serving
templates:
  - knative/knative-serving.yaml
tests:
  - it: should create knative serving when mercury uses knative
    set:
      mercury.enabled: true
      mercury.useKnative: true
      mercury.image.repository: test-mercury
      mercury.image.tag: knative-test
    asserts:
      - isKind:
          of: Service
      - equal:
          path: apiVersion
          value: serving.knative.dev/v1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-mercury
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: mercury

  - it: should not create knative serving when mercury disabled
    set:
      mercury.enabled: false
      mercury.useKnative: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create knative serving when not using knative
    set:
      mercury.enabled: true
      mercury.useKnative: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should have correct image configuration
    set:
      mercury.enabled: true
      mercury.useKnative: true
      mercury.image.repository: test-mercury-knative
      mercury.image.tag: v2.0.0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: test-mercury-knative:v2.0.0

  - it: should have correct scaling configuration
    set:
      mercury.enabled: true
      mercury.useKnative: true
      mercury.knative.minReplicas: 2
      mercury.knative.maxReplicas: 10
    asserts:
      - equal:
          path: spec.template.metadata.annotations["autoscaling.knative.dev/minScale"]
          value: "2"
      - equal:
          path: spec.template.metadata.annotations["autoscaling.knative.dev/maxScale"]
          value: "10"

  - it: should have correct timeout and concurrency
    set:
      mercury.enabled: true
      mercury.useKnative: true
      mercury.timeoutSeconds: 600
      mercury.containerConcurrency: 10
    asserts:
      - equal:
          path: spec.template.metadata.annotations["run.googleapis.com/timeout"]
          value: "600s"
      - equal:
          path: spec.template.spec.containerConcurrency
          value: 10

  - it: should have security context
    set:
      mercury.enabled: true
      mercury.useKnative: true
      mercury.securityContext:
        allowPrivilegeEscalation: false
        runAsNonRoot: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: true

---
suite: test knative crds
templates:
  - knative/knative-crds.yaml
tests:
  - it: should create service custom resource definition
    documentIndex: 0
    asserts:
      - isKind:
          of: CustomResourceDefinition
      - equal:
          path: metadata.name
          value: services.serving.knative.dev
      - equal:
          path: spec.group
          value: serving.knative.dev

  - it: should create configuration custom resource definition
    documentIndex: 1
    asserts:
      - isKind:
          of: CustomResourceDefinition
      - equal:
          path: metadata.name
          value: configurations.serving.knative.dev
      - equal:
          path: spec.group
          value: serving.knative.dev

  - it: should create revision custom resource definition
    documentIndex: 2
    asserts:
      - isKind:
          of: CustomResourceDefinition
      - equal:
          path: metadata.name
          value: revisions.serving.knative.dev
      - equal:
          path: spec.group
          value: serving.knative.dev

  - it: should create route custom resource definition
    documentIndex: 3
    asserts:
      - isKind:
          of: CustomResourceDefinition
      - equal:
          path: metadata.name
          value: routes.serving.knative.dev
      - equal:
          path: spec.group
          value: serving.knative.dev 