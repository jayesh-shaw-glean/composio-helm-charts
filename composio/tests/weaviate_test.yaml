suite: test weaviate deployment
templates:
  - weaviate/weaviate.yaml
tests:
  - it: should not create resources when weaviate is disabled
    set:
      weaviate.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should create weaviate deployment when enabled
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
    documentIndex: 0
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-weaviate
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: weaviate

  - it: should have correct replica count
    set:
      weaviate.enabled: true
      weaviate.replicaCount: 2
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
    documentIndex: 0
    asserts:
      - equal:
          path: spec.replicas
          value: 2

  - it: should use correct image
    set:
      weaviate.enabled: true
      weaviate.image.repository: my-weaviate
      weaviate.image.tag: "1.24.0"
      weaviate.image.pullPolicy: IfNotPresent
    documentIndex: 0
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ".*/my-weaviate:1.24.0$"
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: IfNotPresent

  - it: should have correct port configuration
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
      weaviate.service.port: 8080
      weaviate.service.grpcPort: 50051
    documentIndex: 0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 8080
      - equal:
          path: spec.template.spec.containers[0].ports[0].name
          value: http
      - equal:
          path: spec.template.spec.containers[0].ports[1].containerPort
          value: 50051
      - equal:
          path: spec.template.spec.containers[0].ports[1].name
          value: grpc

  - it: should have liveness probe
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
    documentIndex: 0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /v1/.well-known/ready
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 8080

  - it: should have readiness probe
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
    documentIndex: 0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /v1/.well-known/ready
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 8080

  - it: should have rolling update strategy
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
    documentIndex: 0
    asserts:
      - equal:
          path: spec.strategy.type
          value: RollingUpdate
      - equal:
          path: spec.strategy.rollingUpdate.maxUnavailable
          value: 0
      - equal:
          path: spec.strategy.rollingUpdate.maxSurge
          value: 1

  - it: should include image pull secrets when configured
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
      global.imagePullSecrets:
        - name: weaviate-secret
    documentIndex: 0
    asserts:
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: weaviate-secret

  - it: should have correct resource limits
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
      weaviate.resources:
        requests:
          memory: "2Gi"
          cpu: "500m"
        limits:
          memory: "4Gi"
          cpu: "2"
    documentIndex: 0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: "2Gi"
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: "2"

  - it: should configure authentication environment variables
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
      weaviate.auth.anonymousAccess: "false"
    documentIndex: 0
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED
            value: "false"

  - it: should configure vectorizer and modules
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
      weaviate.vectorizer: "text2vec-openai"
      weaviate.modules: "text2vec-openai,generative-openai"
    documentIndex: 0
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DEFAULT_VECTORIZER_MODULE
            value: "text2vec-openai"
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: ENABLE_MODULES
            value: "text2vec-openai,generative-openai"

  - it: should apply node selector when configured
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
      weaviate.nodeSelector:
        kubernetes.io/os: linux
    documentIndex: 0
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector["kubernetes.io/os"]
          value: linux

  - it: should apply tolerations when configured
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
      weaviate.tolerations:
        - key: "dedicated"
          operator: "Equal"
          value: "weaviate"
          effect: "NoSchedule"
    documentIndex: 0
    asserts:
      - contains:
          path: spec.template.spec.tolerations
          content:
            key: "dedicated"
            operator: "Equal"
            value: "weaviate"
            effect: "NoSchedule"

  - it: should apply security context when configured
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
      weaviate.securityContext:
        runAsNonRoot: true
        runAsUser: 1000
    documentIndex: 0
    asserts:
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsNonRoot
          value: true
      - equal:
          path: spec.template.spec.containers[0].securityContext.runAsUser
          value: 1000

  - it: should mount persistence volume when enabled
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
      weaviate.persistence.enabled: true
    documentIndex: 0
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: data
            mountPath: /var/lib/weaviate
      - contains:
          path: spec.template.spec.volumes
          content:
            name: data
            persistentVolumeClaim:
              claimName: RELEASE-NAME-weaviate-pvc

---
suite: test weaviate persistent volume claim
templates:
  - weaviate/weaviate.yaml
tests:
  - it: should not create PVC when persistence is disabled
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
      weaviate.persistence.enabled: false
    asserts:
      - hasDocuments:
          count: 2

  - it: should create PVC when persistence is enabled
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
      weaviate.persistence.enabled: true
    documentIndex: 1
    asserts:
      - isKind:
          of: PersistentVolumeClaim
      - equal:
          path: metadata.name
          value: RELEASE-NAME-weaviate-pvc

  - it: should configure PVC storage size
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
      weaviate.persistence.enabled: true
      weaviate.persistence.size: "50Gi"
    documentIndex: 1
    asserts:
      - equal:
          path: spec.resources.requests.storage
          value: "50Gi"

  - it: should configure PVC storage class
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
      weaviate.persistence.enabled: true
      weaviate.persistence.storageClass: "fast-ssd"
    documentIndex: 1
    asserts:
      - equal:
          path: spec.storageClassName
          value: "fast-ssd"

---
suite: test weaviate service
templates:
  - weaviate/weaviate.yaml
tests:
  - it: should create weaviate service when enabled
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
      weaviate.persistence.enabled: true
    documentIndex: 2
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-weaviate
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: weaviate

  - it: should have correct service type and ports
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
      weaviate.persistence.enabled: true
      weaviate.service.type: ClusterIP
      weaviate.service.port: 8080
      weaviate.service.grpcPort: 50051
    documentIndex: 2
    asserts:
      - equal:
          path: spec.type
          value: ClusterIP
      - equal:
          path: spec.ports[0].port
          value: 8080
      - equal:
          path: spec.ports[0].name
          value: http
      - equal:
          path: spec.ports[1].port
          value: 50051
      - equal:
          path: spec.ports[1].name
          value: grpc

  - it: should have correct selector labels
    set:
      weaviate.enabled: true
      weaviate.image.repository: test-weaviate
      weaviate.image.tag: "v1.0.0"
      weaviate.persistence.enabled: true
    documentIndex: 2
    asserts:
      - equal:
          path: spec.selector["app.kubernetes.io/component"]
          value: weaviate
