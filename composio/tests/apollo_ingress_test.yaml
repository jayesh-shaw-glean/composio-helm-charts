suite: test apollo ingress
templates:
  - apollo/apollo-ingress.yaml
tests:
  - it: should not create ingress when disabled
    set:
      apollo.ingress.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should create ingress when enabled
    set:
      apollo.ingress.enabled: true
      apollo.ingress.host: api.example.com
    asserts:
      - isKind:
          of: Ingress
      - matchRegex:
          path: metadata.name
          pattern: ".*-apollo-ingress$"
      - equal:
          path: metadata.labels["app.kubernetes.io/component"]
          value: apollo-ingress

  - it: should have default nginx annotations
    set:
      apollo.ingress.enabled: true
    asserts:
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/rewrite-target"]
          value: /
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/ssl-redirect"]
          value: "true"
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/proxy-body-size"]
          value: 50m
      - equal:
          path: metadata.annotations["nginx.ingress.kubernetes.io/use-regex"]
          value: "true"

  - it: should merge custom annotations
    set:
      apollo.ingress.enabled: true
      apollo.ingress.annotations:
        kubernetes.io/ingress.class: nginx
        cert-manager.io/cluster-issuer: letsencrypt-prod
    asserts:
      - equal:
          path: metadata.annotations["kubernetes.io/ingress.class"]
          value: nginx
      - equal:
          path: metadata.annotations["cert-manager.io/cluster-issuer"]
          value: letsencrypt-prod

  - it: should set ingress class name when configured
    set:
      apollo.ingress.enabled: true
      apollo.ingress.className: nginx
    asserts:
      - equal:
          path: spec.ingressClassName
          value: nginx

  - it: should use configured host
    set:
      apollo.ingress.enabled: true
      apollo.ingress.host: api.example.com
    asserts:
      - equal:
          path: spec.rules[0].host
          value: api.example.com

  - it: should use default host from global domain when host not configured
    set:
      apollo.ingress.enabled: true
      global.domain: mycompany.com
      apollo.ingress.host: ""
    asserts:
      - equal:
          path: spec.rules[0].host
          value: apollo.mycompany.com

  - it: should have correct path configuration
    set:
      apollo.ingress.enabled: true
    asserts:
      - equal:
          path: spec.rules[0].http.paths[0].path
          value: /
      - equal:
          path: spec.rules[0].http.paths[0].pathType
          value: Prefix

  - it: should route to apollo service with correct port
    set:
      apollo.ingress.enabled: true
      apollo.service.port: 9900
    asserts:
      - matchRegex:
          path: spec.rules[0].http.paths[0].backend.service.name
          pattern: ".*-apollo$"
      - equal:
          path: spec.rules[0].http.paths[0].backend.service.port.number
          value: 9900

  - it: should configure TLS when provided
    set:
      apollo.ingress.enabled: true
      apollo.ingress.host: api.example.com
      apollo.ingress.tls:
        - secretName: apollo-tls-secret
          hosts:
            - api.example.com
    asserts:
      - equal:
          path: spec.tls[0].secretName
          value: apollo-tls-secret
      - contains:
          path: spec.tls[0].hosts
          content: api.example.com

  - it: should not include TLS when not configured
    set:
      apollo.ingress.enabled: true
      apollo.ingress.host: api.example.com
    asserts:
      - isNull:
          path: spec.tls
