suite: test apollo deployment
templates:
  - apollo/apollo.yaml
tests:
  - it: should create apollo deployment
    documentIndex: 1
    set:
      redis.enabled: true
      externalRedis.enabled: false
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-apollo
      - equal:
          path: metadata.labels.app
          value: apollo
      - equal:
          path: metadata.labels.release
          value: RELEASE-NAME

  - it: should have correct replica count
    documentIndex: 1
    set:
      redis.enabled: true
      externalRedis.enabled: false
      apollo.replicaCount: 3
    asserts:
      - equal:
          path: spec.replicas
          value: 3

  - it: should use correct image
    documentIndex: 1
    set:
      redis.enabled: true
      externalRedis.enabled: false
      apollo.image.repository: test-repo
      apollo.image.tag: test-tag
      apollo.image.pullPolicy: IfNotPresent
    asserts:
      - matchRegex:
          path: spec.template.spec.containers[0].image
          pattern: ".*/test-repo:test-tag$"
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: IfNotPresent

  - it: should have correct port configuration
    documentIndex: 1
    set:
      redis.enabled: true
      externalRedis.enabled: false
    asserts:
      - equal:
          path: spec.template.spec.containers[0].ports[0].containerPort
          value: 9900

  - it: should have liveness probe
    documentIndex: 1
    set:
      redis.enabled: true
      externalRedis.enabled: false
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /api/healthz
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.port
          value: 9900
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 60

  - it: should have readiness probe
    documentIndex: 1
    set:
      redis.enabled: true
      externalRedis.enabled: false
    asserts:
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /api/healthz
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.port
          value: 9900

  - it: should have rolling update strategy
    documentIndex: 1
    set:
      redis.enabled: true
      externalRedis.enabled: false
    asserts:
      - equal:
          path: spec.strategy.type
          value: RollingUpdate
      - equal:
          path: spec.strategy.rollingUpdate.maxUnavailable
          value: 0
      - equal:
          path: spec.strategy.rollingUpdate.maxSurge
          value: 1

  - it: should include image pull secrets when configured
    documentIndex: 1
    set:
      redis.enabled: true
      externalRedis.enabled: false
      global.imagePullSecrets:
        - name: test-secret
    asserts:
      - equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: test-secret

  - it: should have correct resource limits
    documentIndex: 1
    set:
      redis.enabled: true
      externalRedis.enabled: false
      apollo.resources:
        requests:
          memory: "2Gi"
          cpu: "1"
        limits:
          memory: "2Gi"
          cpu: "1"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: "2Gi"
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: "1"
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: "2Gi"
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: "1"

---
suite: test apollo service
templates:
  - apollo/apollo.yaml
tests:
  - it: should create apollo service
    documentIndex: 0
    set:
      redis.enabled: true
      externalRedis.enabled: false
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-apollo
      - equal:
          path: metadata.labels.app
          value: apollo

  - it: should have correct service type and port
    documentIndex: 0
    set:
      redis.enabled: true
      externalRedis.enabled: false
      apollo.service.type: NodePort
      apollo.service.port: 9900
      apollo.service.nodePort: 30900
    asserts:
      - equal:
          path: spec.type
          value: NodePort
      - equal:
          path: spec.ports[0].port
          value: 9900

  - it: should have correct selector labels
    documentIndex: 0
    set:
      redis.enabled: true
      externalRedis.enabled: false
    asserts:
      - equal:
          path: spec.selector.app
          value: apollo
      - equal:
          path: spec.selector.release
          value: RELEASE-NAME
