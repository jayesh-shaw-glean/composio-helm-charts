# Development values for Composio
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Namespace configuration
# If create is true, the chart will create namespaces needed by services
# If create is false, you need to create namespaces externally before deploying
namespace:
  create: false
  # Name of the namespace where Composio services will be deployed
  # If not specified, defaults to "composio"
  name: "composio"

global:
  environment: production
  domain: localhost

# Disable built-in databases since we're using external PostgreSQL
postgresql:
  enabled: false

redis:
  fullnameOverride: "redis-composio"
  auth:
    enabled: true
    password: "redis123"
  architecture: standalone
  master:
    persistence:
      enabled: true
      size: 2Gi
    # Disable privileged sysctls for GKE Autopilot
    sysctlImage:
      enabled: false
    sysctl:
      enabled: false

# Apollo service configuration - Development
apollo:
  database:
    urlSecret:
      name: "external-postgres-secret"
      key: "url"
  serviceAccountName: composio-ksa

  # Note: Secrets are now managed globally in the 'secrets' section

# MCP service configuration - Development
mcp:
  database:
    urlSecret:
      name: "external-postgres-secret"
      key: "url"
  serviceAccountName: composio-ksa

  # Note: Secrets are now managed globally in the 'secrets' section

  # Note: Secrets are now managed globally in the 'secrets' section

# DB Init - Enabled for development
dbInit:
  adminEmail: "admin@composio.dev"
  database:
    urlSecret:
      name: "external-postgres-secret"
      key: "url"
  serviceAccountName: composio-ksa

# Enable development monitoring
prometheus:
  enabled: false
  nodeExporter:
    enabled: false
  # Fix imagePullSecrets format for GKE Autopilot compatibility
  imagePullSecrets: []

grafana:
  enabled: false
  replicas: 1

testFramework:
  enabled: false

rbac:
  create: false
  pspEnabled: false
  namespaced: true

# Explicitly disable Elasticsearch and ensure no privileged containers
elasticsearch:
  enabled: false

cassandra:
  enabled: false

# Ingress disabled for development (use port-forward)
ingress:
  enabled: false

# Service Account
serviceAccount:
  create: true
  # create: true
  annotations: {}
  name: "composio-knative-sa"

# Global node selector - applied to all workloads
# Default is empty - should be set via Terraform based on deployment configuration
nodeSelector: &globalNodeSelector
  {}

# Tolerations - needed for nodes with taints
# Default is empty - should be set via Terraform based on deployment configuration
tolerations: &globalTolerations
  []

# Affinity - disabled for development
affinity: {}

# AWS configuration - disabled for development
aws:
  region: us-east-1
  s3:
    lambdaBucketName: "tools"
  lambda:
    functionName: "mercury"
    image: "us-central1-docker.pkg.dev/scio-engineering/glean-images/composio-lambda:latest"

# Mercury service configuration - Development
mercury:
  enabled: true
  # Choose deployment method:
  # - useKnative: true  = Serverless with auto-scaling (requires Knative installation)
  # - useKnative: false = Standard Kubernetes deployment
  useKnative: false
  replicaCount: 1
  image:
    imageName: us-central1-docker.pkg.dev/scio-engineering/glean-images/composio-mercury:latest
    pullPolicy: Always

  # Let the container use its default entrypoint
  # command: []
  # args: []

  service:
    type: ClusterIP
    port: 8080

  autoscaling:
    minScale: 1
    maxScale: 10
    target: 80

  containerConcurrency: 0
  timeoutSeconds: 300

  knative:
    minReplicas: 3
    replicas: 10
    maxReplicas: 20
    # Add Knative-specific security context for GKE Autopilot

  # Add security context to ensure proper user permissions
  securityContext:
    allowPrivilegeEscalation: false
    runAsNonRoot: true
    runAsUser: 1000
    capabilities:
      drop:
        - ALL
    seccompProfile:
      type: RuntimeDefault

  ingress:
    enabled: false
    className: ""
    annotations: {}
    host: ""
    tls: []

  # Environment variables are now configured directly in templates/mercury-service.yaml
  volumeMounts: []
  volumes: []

# Temporal configuration - Using official helm chart as dependency with external PostgreSQL
temporal:
  fullnameOverride: "temporal-composio"
  serviceAccount:
    create: false
    name: composio-ksa

  server:
    enabled: true
    replicaCount: 1

    config:
      logLevel: "info"
      numHistoryShards: 512

      # Configure persistence to use PostgreSQL from external secret
      persistence:
        # defaultStore: default

        # Main temporal database
        default:
          driver: "sql"
          sql:
            driver: "postgres12"
            host: "127.0.0.1"
            port: 5432
            database: "temporal"
            user: "composio"
            existingSecret: "external-postgres-secret"
            existingSecretPasswordKey: "password"
            maxConns: 20
            maxIdleConns: 20
            maxConnLifetime: "1h"

        # Visibility database (will be created by schema setup)
        visibility:
          driver: "sql"
          sql:
            driver: "postgres12"
            host: "127.0.0.1"
            port: 5432
            database: "temporal_visibility"
            user: "composio"
            existingSecret: "external-postgres-secret"
            existingSecretPasswordKey: "password"
            maxConns: 20
            maxIdleConns: 20
            maxConnLifetime: "1h"
      namespaces:
        # Enable this to create namespaces
        create: true
        namespace:
          - name: default
            retention: 7d
    extraEnv:
      - name: SQL_TLS_ENABLED
        value: "false"
      - name: SQL_TLS_DISABLE_HOST_VERIFICATION
        value: "true"

    # Frontend service configuration
    frontend:
      service:
        type: ClusterIP
        port: 7233
        membershipPort: 6933
        httpPort: 7243

    createDatabase:
      enabled: true
    setup:
      enabled: true
      backoffLimit: 100
    update:
      enabled: true
      backoffLimit: 100

  # Target the default 'worker'
  # worker:
  #   nodeSelector:
  #     workload-type: temporal

  # Disable built-in databases (using external PostgreSQL)
  cassandra:
    enabled: false
  mysql:
    enabled: false
  elasticsearch:
    enabled: false

  # Disable additional monitoring for now
  prometheus:
    enabled: false
    nodeExporter:
      enabled: false
  grafana:
    enabled: false
